# 各プログラムファイルの役割

* `index.html`
  * UIを提供する。
* `mikeAssembler.js`
  * アセンブラ本体 `mikeAssembler` を提供する。
  * UIの操作を提供する。
* `outputFormat/*.js`
  * アセンブル結果を整形して出力するプログラムを提供する。
  * 同プログラムを本体に登録する。
* `terget/*.js`
  * ターゲットの命令セットごとのアセンブルを行うプログラムを提供する。
  * 同プログラムを本体に登録する。

# 扱うデータ

`BigInt` を使うとされている場所において、`BigInt` に非対応の環境では `number` を用いる。

## 行変換器

1行分のデータをバイト列に変換する関数を提供するオブジェクト。

以下のプロパティを持つ。

* `name` : このオブジェクトを識別する名前。 (文字列)
* `assemble` : 1行分のデータをバイト列に変換する関数。
  * 引数
    * `pos` : このデータを出力するラベル用の位置を表す`BigInt`。
    * `inst` : 変換する命令を表す文字列。
    * `ops` : 変換する命令のオペランドを表す文字列の配列。
    * `context` : 現在の状態を表すコンテキスト。 (オブジェクト)
  * 返り値
    * 行変換結果。 (オブジェクト)
  * 備考
    * `context` の中身は、`targetData`内の自分の名前のプロパティを除き、書き換えてはいけない。

## 出力整形器

アセンブル結果を整形して出力する関数を提供するオブジェクト。

以下のプロパティを持つ。

* `name` : このオブジェクトを識別する名前。 (文字列)
* `generateOutput` : アセンブル結果を整形して出力する関数。
  * 引数
    * `outputParts` : アセンブル結果情報の配列。
    * `outputConfig` : 出力設定。 (オブジェクト)
  * 返り値
    * 以下のプロパティを持つオブジェクト。
      * `output` : 出力結果の文字列。
      * `message` : 出力にあたり生成された警告などを表す文字列。

## 行解析結果

アセンブラのソースコードの1行をパースした結果のオブジェクト。

以下のプロパティを持つ。

* `line` : 入力行のタブをスペースに変換した文字列。
* `label` : この行で付けられているラベルを表す文字列。ラベルが無い場合は`null`。
* `inst` : この行の命令を表す文字列。命令が無い場合は`null`。
* `ops` : この行の命令のオペランドを表す文字列の配列。

## トークン

式を構文解析用に分割した1個の部分を表すオブジェクト。

以下のプロパティを持つ。

* `kind` : トークンの種類を表す文字列。
  * `op` : 演算子
  * `str` : 文字列または文字リテラル (`""` または `''` で囲まれたもの)
  * `value` : 数値または識別子
* `token` : 分割した部分の文字列。

## ASTノード

式(トークン列)の構文解析結果を表す木の頂点を表すオブジェクト。

以下のプロパティを持つ。

* `kind` : ノードの種類を表す文字列。
  * `op` : 演算子
  * `str` : 文字列または文字リテラル (`""` または `''` で囲まれたもの)
  * `value` : 数値または識別子
* `value` : ノードのデータを表す文字列。
* `children` : このノードの子となるASTノードの配列。

## 行変換結果

1行を変換した結果を表すオブジェクト。

以下のプロパティを持つ。

* `nextPos` : 次の行の出力開始位置を表す `BigInt`。
* `data` : 出力するワードを表す `BigInt` の配列。
  * 値を確定できない要素は`null`で表す。
* `wordSize`: 1ワードのバイト数を表す数値。もしくは、`0`で1ワードがニブル(4ビット)であることを表す。

以下のプロパティを持ってもよい。

* `warning` : 変換時に生じた警告を表す文字列。
* `warnings` : 変換時に生じた警告を表す文字列の配列。

## コンテキスト

アセンブルの状態を表すオブジェクト。

以下のプロパティを持つ。

* `passLimit` : ラベルが収束しない場合、アセンブル処理を何回まで行うかを表す数値。
* `pass` : 現在何回目のアセンブル処理をしているかを表す数値。 (最初が1)
* `passLimitSet` : アセンブル処理の最大回数を設定する命令が現れたかを表す真偽値。
* `target` : 現在変換に用いる行変換器。未設定の場合は`null`。
* `outStart` : 出力を開始するアドレスを表す `BigInt`。未設定の場合は`null`。
* `endianness` : 出力に用いるエンディアンを表す文字列。
* `posOffset` : 「出力データ上の位置」を求めるために「ラベル用の位置」に足す値 (`BigInt`)。
* `vars` : 式から参照できる識別子(文字列)をその値(`BigInt`)に対応付ける連想配列。
* `defines` : `define`命令で定義した識別子(文字列)をその値(`BigInt`)に対応付ける連想配列。
* `labels` : ラベル(文字列)をその値(`BigInt`)に対応付ける連想配列。
* `labelsPrev` : 前回のアセンブル処理で定義されたラベル(文字列)とその値(`BigInt`)の連想配列。
* `labelArray` : 定義されたラベルの名前(文字列)を格納する配列。
* `targetData` : 行変換器の名前をキーとし、行変換器が用いるデータを格納する連想配列。

## アセンブル結果パーツ

アセンブル結果の一部を表すオブジェクト。

以下のプロパティを持つ。

* `line` : 変換元の行を表す文字列。
* `lineno` : 変換元の行番号を表す数値。 (最初の行が1)
* `pos` : データを配置を開始する場所(アドレス)を表す`BigInt`。
* `data` : 配置するバイト列を表す数値(0～255)の配列。
* `wordSize` : この部分の1ワードが何バイトかを表す数値。`0`は1ワードがニブル(4ビット)であることを表す。

## 出力設定

どのような形式で出力するかを調整するためのオブジェクト。

以下のプロパティを持つ。

* `outputFormat` : 使用する出力整形器の名前を表す文字列。
* `wordSize` : 出力に用いるワードサイズを表す文字列。 (10進数値または `"auto"`)
* `endianness` : 複数のバイトかならるワードの出力に用いるエンディアンを表す文字列。
* `defaultByte` : 「未定義」を置けない出力形式において、未定義の部分を埋めるために用いるバイトの値を表す文字列。 (`parseInt` で数値にできる形式)
* `addressFormat` : アドレスを文字列として出力する際の出力形式を表す文字列。
* `dataFormat` : アセンブル結果のデータを文字列として出力する際の出力形式を表す文字列。

# mikeAssembler が提供するAPI

## isBigIntSupported

この環境で`BigInt`が使えるかを判定する。

### 引数

なし

### 返り値

この環境で `BigInt` が使用可能なら`true`、使用不可能なら`false`を返す。

## toBigInt

データ(数値または数値を表す文字列)を`BigInt`に変換する。  
`BigInt`に未対応の環境では、整数に変換する。

### 引数

* `v` : `BigInt` に変換する数値を表すデータ。

### 返り値

`BigInt` が使用可能な環境の場合、`v`を`BigInt`に変換して返す。  
そうでない場合、`v`を整数に変換して返す。

## fromBigInt

`BigInt`または整数(`BigInt`に未対応の環境を想定)を、通常の数値に変換する。

### 引数

* `v` : 通常の数値に変換する値。

### 返り値

`v`を通常の数値(整数)に変換した値。

## registerTarget

行変換器を登録する。

### 引数

* `target` : 登録する行変換器。

### 返り値

なし

## registerOutputFormat

出力整形器を登録する。

### 引数

* `of` : 登録する出力整形器。

### 返り値

なし

## tokenize

式を表す文字列を、トークンに分割する。

### 引数

* `expr` : 式を表す文字列。

### 返り値

分割結果のトークンの配列。

## parse

式を表すトークン列の構文解析を行う。

### 引数

* `tokens` : 式を表すトークンの配列。

### 返り値

構文解析結果を表すASTノード。

## parseString

(アセンブラの文法上の)文字列または文字リテラルを表す(JavaScriptの)文字列をパースし、バイト列に変換する。

### 引数

* `str` : パースする文字列。

### 返り値

変換結果のバイト列を表す数値(0～255)の配列。

## evaluate

式を評価し、値を返す。

### 引数

* `ast` : 評価する式を表すASTノード。
* `vars` : 識別子(文字列)をその値(`BigInt`)に対応付ける連想配列。
* `throwOnUndefinedIdentifier` : 未定義の識別子があった場合に例外を投げるかを表す真偽値。 (省略可能、省略時`true`)
  * `true` : 未定義の識別子があった場合は例外を投げる
  * `false` : 未定義の識別子があった場合は `null` を返す
* `hook` : 評価方法を変えるための関数。 (省略可能、省略時`null`)
  * `null` でない場合、ASTのそれぞれのノードについて呼び出される
  * `null`以外を返した場合、そのノードについて標準の評価を行うかわりにその値を返す
  * 引数
    * `ast` : 評価中のASTノード。
    * `vars` : 識別子(文字列)をその値(`BigInt`)に対応付ける連想配列。
  * 返り値
    * 評価結果の値(`BigInt`)または`null`。

## fitsInBitsSigned

指定した値が、指定したビット数の符号付き整数(2の補数表現)で表せるかをチェックする。

### 引数

* `value` : チェックする値 (`BigInt`)
* `nBits` : ビット数 (通常の整数)

### 返り値

`value` が `nBits` で表現できるならば`true`、できないならば`false`。

## fitsInBitsUnsigned

指定した値が、指定したビット数の符号無し整数で表せるかをチェックする。

### 引数

* `value` : チェックする値 (`BigInt`)
* `nBits` : ビット数 (通常の整数)

### 返り値

`value` が `nBits` で表現できるならば`true`、できないならば`false`。

## assemble

アセンブルを行う。

### 引数

* `source` : アセンブルを行うソースコード(文字列)。
* `outputConfig` : 出力設定。 (オブジェクト)

### 返り値

以下のプロパティを持つオブジェクト。

* `output` : アセンブル結果を表す文字列。
* `message` : アセンブル中の警告やエラーを表す文字列。
* `error` : アセンブルにおいてエラーを検出したかを表す真偽値。
